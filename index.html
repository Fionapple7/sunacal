<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>チーム予定カレンダー</title>
<style>
  :root {
    color-scheme: light;
    font-size: 18px;
    --bg: #f7f7f9;
    --card-bg: #ffffff;
    --primary: #2d5dd9;
    --accent: #f4b400;
    --border: #d7d9e0;
    --text: #262840;
    --text-muted: #55596d;
  }

  @media (min-width: 1024px) {
    :root {
      font-size: 20px;
    }
  }

  body {
    margin: 0;
    font-family: "Hiragino Sans", "Noto Sans JP", "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    background: #1c2351;
    color: #fff;
    padding: 0.75rem 1.25rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    position: sticky;
    top: 0;
    z-index: 5;
  }

  header h1 {
    font-size: 1.25rem;
    margin: 0;
    flex: 1;
  }

  .toolbar {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  button,
  select,
  input,
  textarea,
  label {
    font-size: 1rem;
  }

  .toolbar button {
    background: #fff;
    border: none;
    border-radius: 999px;
    padding: 0.55rem 1.1rem;
    font-weight: 600;
    color: #1c2351;
    box-shadow: 0 2px 6px rgba(28, 35, 81, 0.25);
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
  }

  .toolbar button:hover,
  .toolbar button:focus-visible {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(28, 35, 81, 0.3);
    outline: none;
  }

  main {
    padding: 1rem clamp(1rem, 4vw, 2.5rem) 2.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    flex: 1;
  }

  .calendar-container {
    background: var(--card-bg);
    border-radius: 1rem;
    box-shadow: 0 6px 20px rgba(40, 44, 63, 0.12);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .view-header {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem 0.5rem;
  }

  .view-header h2 {
    margin: 0;
    font-size: clamp(1.25rem, 3vw, 1.6rem);
  }

  .nav-buttons {
    display: flex;
    gap: 0.5rem;
  }

  .nav-buttons button {
    background: #eef2ff;
    color: #1c2351;
    border-radius: 0.75rem;
    padding: 0.4rem 0.9rem;
    border: none;
    font-weight: 600;
    box-shadow: none;
    cursor: pointer;
  }

  .month-grid,
  .week-grid {
    display: grid;
    gap: 1px;
    background: var(--border);
  }

  .month-grid {
    grid-template-columns: repeat(7, 1fr);
    border-top: 1px solid var(--border);
  }

  .week-grid {
    grid-template-columns: repeat(7, minmax(12rem, 1fr));
    overflow-x: auto;
  }

  .weekday-labels {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f0f2ff;
    color: #1c2351;
    font-weight: 600;
    text-align: center;
    padding: 0.65rem 0;
    border-bottom: 1px solid var(--border);
  }

  .weekday-labels span {
    font-size: 0.95rem;
  }

  .day-cell {
    background: var(--card-bg);
    min-height: 7.5rem;
    display: flex;
    flex-direction: column;
    padding: 0.6rem clamp(0.5rem, 2vw, 0.9rem);
    gap: 0.45rem;
    cursor: pointer;
    position: relative;
  }

  .week-grid .day-cell {
    min-height: 9rem;
  }

  .day-cell.today {
    box-shadow: inset 0 0 0 3px var(--accent);
    border-radius: 0.85rem;
  }

  .day-number {
    font-size: 1.05rem;
    font-weight: 700;
  }

  .day-number small {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-left: 0.35rem;
  }

  .day-cell .event-pill {
    border-radius: 0.75rem;
    padding: 0.35rem 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #1f2339;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 6px rgba(31, 35, 57, 0.1);
  }

  .event-pill .dot {
    width: 0.75rem;
    height: 0.75rem;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .event-pill strong {
    font-weight: 700;
  }

  .empty {
    opacity: 0.25;
  }

  .day-detail {
    background: var(--card-bg);
    border-radius: 1rem;
    box-shadow: 0 6px 20px rgba(40, 44, 63, 0.12);
    padding: 1.5rem;
  }

  .day-detail header {
    background: none;
    color: inherit;
    padding: 0;
    position: static;
    gap: 1rem;
  }

  .day-detail header h3 {
    margin: 0;
    font-size: clamp(1.3rem, 4vw, 1.6rem);
  }

  .day-detail .event-card {
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 1rem;
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    background: #fdfdff;
  }

  .event-meta {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    font-weight: 600;
  }

  .event-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .event-actions button {
    border-radius: 0.75rem;
    padding: 0.45rem 0.9rem;
    border: none;
    font-weight: 600;
    cursor: pointer;
  }

  .event-actions .edit {
    background: var(--primary);
    color: #fff;
  }

  .event-actions .delete {
    background: #ff6b6b;
    color: #fff;
  }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(24, 28, 51, 0.55);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    z-index: 20;
  }

  .modal {
    background: var(--card-bg);
    border-radius: 1.25rem;
    max-width: 32rem;
    width: min(96vw, 32rem);
    max-height: 95vh;
    overflow-y: auto;
    padding: clamp(1.25rem, 3vw, 1.8rem);
    box-shadow: 0 20px 60px rgba(26, 32, 66, 0.35);
  }

  .modal h3 {
    margin-top: 0;
    font-size: 1.35rem;
  }

  .form-group {
    margin-bottom: 1.1rem;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  label {
    font-weight: 600;
  }

  input[type="text"],
  input[type="datetime-local"],
  input[type="date"],
  input[type="time"],
  select,
  textarea {
    border-radius: 0.75rem;
    border: 1px solid var(--border);
    padding: 0.55rem 0.75rem;
    font-size: 1rem;
    background: #fff;
  }

  .member-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(9rem, 1fr));
    gap: 0.5rem;
  }

  .member-checkbox {
    background: #f5f6ff;
    border-radius: 0.75rem;
    padding: 0.4rem 0.65rem;
    display: flex;
    align-items: center;
    gap: 0.45rem;
  }

  .member-checkbox input {
    transform: scale(1.2);
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    margin-top: 1.5rem;
  }

  .modal-footer button {
    border-radius: 0.75rem;
    border: none;
    padding: 0.6rem 1.1rem;
    font-weight: 700;
    cursor: pointer;
  }

  .modal-footer .cancel {
    background: #e1e3f3;
    color: #1f2441;
  }

  .modal-footer .delete {
    background: #ff6b6b;
    color: #fff;
  }

  .modal-footer .save {
    background: var(--primary);
    color: #fff;
  }

  .event-list-overlay {
    position: fixed;
    inset: 0;
    background: rgba(24, 28, 51, 0.55);
    display: none;
    align-items: stretch;
    justify-content: center;
    padding: clamp(1rem, 4vw, 2rem);
    z-index: 25;
  }

  .event-list-panel {
    background: var(--card-bg);
    border-radius: 1.25rem;
    max-width: 48rem;
    width: min(98vw, 48rem);
    max-height: 95vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(26, 32, 66, 0.35);
    overflow: hidden;
  }

  .event-list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: clamp(1rem, 3vw, 1.5rem);
    border-bottom: 1px solid var(--border);
    gap: 1rem;
  }

  .event-list-header h3 {
    margin: 0;
    font-size: clamp(1.2rem, 3vw, 1.5rem);
  }

  .overlay-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .overlay-actions button:not(:last-child) {
    background: #e1e3f3;
    color: #1f2441;
  }

  .event-list {
    flex: 1;
    overflow-y: auto;
    padding: clamp(1rem, 3vw, 1.5rem);
    display: grid;
    gap: 0.75rem;
  }

  .event-list-item {
    border: 1px solid var(--border);
    border-radius: 1rem;
    padding: 0.9rem clamp(0.9rem, 3vw, 1.2rem);
    background: #fdfdff;
    display: grid;
    gap: 0.5rem;
  }

  .event-list-item header {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0.5rem;
    justify-content: space-between;
  }

  .event-list-item header h4 {
    margin: 0;
    font-size: 1.05rem;
  }

  .event-list-item .meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
  }

  .event-list-item .actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .event-list-item .actions button {
    border: none;
    border-radius: 0.75rem;
    padding: 0.45rem 0.9rem;
    font-weight: 600;
    cursor: pointer;
  }

  .event-list-item .actions .edit {
    background: var(--primary);
    color: #fff;
  }

  .event-list-item .actions .delete {
    background: #ff6b6b;
    color: #fff;
  }

  .overlay-week-grid {
    flex: 1;
    overflow: auto;
    padding: clamp(1rem, 3vw, 1.5rem);
    background: #f8f9ff;
  }

  .overlay-week-grid .day-cell {
    min-height: 8rem;
  }

  .overlay-day-detail {
    flex: 1;
    overflow-y: auto;
    padding: clamp(1rem, 3vw, 1.5rem);
    display: grid;
    gap: 0.75rem;
    background: #f8f9ff;
  }

  .helper-text {
    font-size: 0.9rem;
    color: var(--text-muted);
  }

  .no-events {
    text-align: center;
    padding: 1.5rem;
    color: var(--text-muted);
  }

  .member-add {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .member-add input {
    flex: 1 1 10rem;
  }

  .member-add button {
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    border: none;
    background: #1c2351;
    color: #fff;
    font-weight: 600;
  }

  .recurrence-options {
    display: grid;
    gap: 0.75rem;
  }

  .recurrence-options > label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .weekday-picker {
    display: flex;
    gap: 0.35rem;
    flex-wrap: wrap;
    margin-top: 0.4rem;
  }

  .weekday-picker label {
    background: #f1f2fd;
    border-radius: 999px;
    padding: 0.35rem 0.8rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 600;
    cursor: pointer;
  }

  .weekday-picker input {
    transform: scale(1.2);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (max-width: 768px) {
    header {
      justify-content: center;
    }

    .weekday-labels span {
      font-size: 0.8rem;
    }

    .day-cell {
      min-height: 6.5rem;
    }

    .toolbar {
      justify-content: center;
    }

    .event-pill {
      font-size: 0.8rem;
    }

    .week-grid {
      grid-template-columns: repeat(7, minmax(10rem, 1fr));
    }
  }
</style>
</head>
<body>
<header>
  <h1>チーム予定カレンダー</h1>
  <nav class="toolbar" aria-label="ビュー操作">
    <button type="button" id="monthViewBtn">月間</button>
    <button type="button" id="weekViewBtn">週間</button>
    <button type="button" id="todayBtn">今日へ</button>
    <button type="button" id="eventListBtn">予定一覧</button>
    <button type="button" id="newEventBtn">予定を入力</button>
  </nav>
</header>
<main>
  <section class="calendar-container" aria-live="polite">
    <div class="view-header">
      <div>
        <h2 id="viewTitle"></h2>
        <p class="helper-text" id="viewSubtitle"></p>
      </div>
      <div class="nav-buttons" aria-label="期間移動">
        <button type="button" id="prevBtn">◀ 前</button>
        <button type="button" id="nextBtn">次 ▶</button>
      </div>
    </div>
    <div class="weekday-labels" id="weekdayLabels" aria-hidden="true"></div>
    <div class="month-grid" id="monthGrid"></div>
    <div class="week-grid" id="weekGrid" hidden></div>
  </section>

  <section class="day-detail" aria-live="polite">
    <header>
      <h3 id="dayDetailTitle">本日の予定</h3>
      <div class="toolbar" style="gap:0.35rem;">
        <button type="button" id="backToMonthBtn" style="background:#e1e3f3;color:#1f2441;">月間に戻る</button>
        <button type="button" id="addFromDayBtn">予定を追加</button>
      </div>
    </header>
    <div id="dayEventsContainer" class="day-events"></div>
  </section>
</main>

<div class="modal-overlay" id="eventModalOverlay" role="dialog" aria-modal="true" aria-labelledby="eventModalTitle">
  <div class="modal">
    <h3 id="eventModalTitle">予定を登録</h3>
    <form id="eventForm">
      <input type="hidden" id="eventId" name="eventId">
      <div class="form-group">
        <label for="eventTitle">予定の内容</label>
        <input type="text" id="eventTitle" name="eventTitle" placeholder="例: 顧客ミーティング" required>
      </div>
      <div class="form-group">
        <label>メンバー</label>
        <div class="member-list" id="memberCheckboxes"></div>
        <div class="member-add">
          <input type="text" id="newMemberName" placeholder="メンバー名を追加">
          <button type="button" id="addMemberBtn">追加</button>
        </div>
        <p class="helper-text">複数選択できます。追加したメンバーは保存され、次回以降も選べます。</p>
      </div>
      <div class="form-group">
        <label for="eventDate">日付</label>
        <input type="date" id="eventDate" name="eventDate" required>
      </div>
      <div class="form-group">
        <label for="startTime">開始時間</label>
        <input type="time" id="startTime" name="startTime" required>
      </div>
      <div class="form-group">
        <label for="endTime">終了時間</label>
        <input type="time" id="endTime" name="endTime" required>
      </div>
      <div class="form-group">
        <label for="eventMemo">メモ (任意)</label>
        <textarea id="eventMemo" name="eventMemo" rows="3" placeholder="詳細メモを入力"></textarea>
      </div>
      <div class="form-group">
        <label>繰り返し設定</label>
        <div class="recurrence-options">
          <label><input type="radio" name="recurrence" value="none" checked> 繰り返しなし</label>
          <label><input type="radio" name="recurrence" value="daily"> 毎日</label>
          <div>
            <label><input type="radio" name="recurrence" value="weekly"> 曜日を選択</label>
            <div class="weekday-picker" id="weekdayPicker" aria-hidden="true">
              <label><input type="checkbox" value="1"> 月</label>
              <label><input type="checkbox" value="2"> 火</label>
              <label><input type="checkbox" value="3"> 水</label>
              <label><input type="checkbox" value="4"> 木</label>
              <label><input type="checkbox" value="5"> 金</label>
              <label><input type="checkbox" value="6"> 土</label>
              <label><input type="checkbox" value="0"> 日</label>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group" id="recurrenceEndGroup" hidden>
        <label for="recurrenceEnd">繰り返し終了日</label>
        <input type="date" id="recurrenceEnd" name="recurrenceEnd">
        <p class="helper-text">終了日まで予定が自動で作成されます。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="cancel" id="cancelEventBtn">キャンセル</button>
        <button type="button" class="delete" id="deleteEventBtn" hidden>削除</button>
        <button type="submit" class="save">保存</button>
      </div>
    </form>
  </div>
</div>

<div class="event-list-overlay" id="eventListOverlay" role="dialog" aria-modal="true" aria-labelledby="eventListTitle">
  <div class="event-list-panel">
    <div class="event-list-header">
      <div>
        <h3 id="eventListTitle">予定一覧</h3>
        <p class="helper-text" id="eventListSubtitle">すべての予定を確認できます。編集または削除する予定を選んでください。</p>
      </div>
      <button type="button" class="cancel" id="closeEventListBtn">閉じる</button>
    </div>
    <div class="event-list" id="eventListContainer">
      <p class="helper-text">予定がありません。</p>
    </div>
  </div>
</div>

<script>
  const weekdayLabels = ['月', '火', '水', '木', '金', '土', '日'];
  const colorPalette = ['#ff8a80', '#ffd180', '#ffff8d', '#a7ffeb', '#80d8ff', '#82b1ff', '#b388ff', '#f8bbd0', '#c5e1a5', '#ffab91'];
  const storageKeys = {
    members: 'teamScheduler.members.v1',
    events: 'teamScheduler.events.v1'
  };
  const TODAY = new Date();
  const INITIAL_DATE = new Date(2025, 9, 1);

  const state = {
    view: 'month',
    currentDate: new Date(INITIAL_DATE),
    selectedDate: new Date(INITIAL_DATE)
  };

  const monthGrid = document.getElementById('monthGrid');
  const weekGrid = document.getElementById('weekGrid');
  const weekdayHeader = document.getElementById('weekdayLabels');
  const viewTitle = document.getElementById('viewTitle');
  const viewSubtitle = document.getElementById('viewSubtitle');
  const dayDetailTitle = document.getElementById('dayDetailTitle');
  const dayEventsContainer = document.getElementById('dayEventsContainer');

  const eventModalOverlay = document.getElementById('eventModalOverlay');
  const eventForm = document.getElementById('eventForm');
  const eventIdInput = document.getElementById('eventId');
  const memberCheckboxes = document.getElementById('memberCheckboxes');
  const weekdayPicker = document.getElementById('weekdayPicker');
  const recurrenceEndGroup = document.getElementById('recurrenceEndGroup');
  const addMemberBtn = document.getElementById('addMemberBtn');
  const cancelEventBtn = document.getElementById('cancelEventBtn');
  const deleteEventBtn = document.getElementById('deleteEventBtn');
  const addFromDayBtn = document.getElementById('addFromDayBtn');
  const backToMonthBtn = document.getElementById('backToMonthBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const monthViewBtn = document.getElementById('monthViewBtn');
  const weekViewBtn = document.getElementById('weekViewBtn');
  const todayBtn = document.getElementById('todayBtn');
  const eventListBtn = document.getElementById('eventListBtn');
  const newEventBtn = document.getElementById('newEventBtn');
  const eventListOverlay = document.getElementById('eventListOverlay');
  const eventListContainer = document.getElementById('eventListContainer');
  const closeEventListBtn = document.getElementById('closeEventListBtn');

  let members = loadMembers();
  let events = loadEvents();
  let editingEvent = null;
  let editingContext = 'calendar';

  init();

  function init() {
    renderWeekdayHeader();
    populateMemberCheckboxes();
    renderCalendar();
    renderDayDetail(state.selectedDate);
    attachEventHandlers();
  }

  function loadMembers() {
    const stored = localStorage.getItem(storageKeys.members);
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed) && parsed.length) {
          const renameMap = { '田中': 'いぐお', '佐藤': 'カンパ', '高橋': 'あき', 'かんぱ': 'カンパ' };
          let renamed = false;
          const updated = parsed.map((member) => {
            const newName = renameMap[member.name];
            if (newName && member.name !== newName) {
              renamed = true;
              return { ...member, name: newName };
            }
            return member;
          });
          if (renamed) {
            localStorage.setItem(storageKeys.members, JSON.stringify(updated));
            return updated;
          }
          return parsed;
        }
      } catch (error) {
        console.warn('メンバー情報の読み込みに失敗しました。初期値を再作成します。', error);
      }
    }
    const defaults = [
      { id: 'm1', name: 'いぐお', color: '#ff8a80' },
      { id: 'm2', name: 'カンパ', color: '#82b1ff' },
      { id: 'm3', name: 'あき', color: '#a7ffeb' }
    ];
    localStorage.setItem(storageKeys.members, JSON.stringify(defaults));
    return defaults;
  }

  function loadEvents() {
    const stored = localStorage.getItem(storageKeys.events);
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        if (Array.isArray(parsed)) return parsed;
      } catch (error) {
        console.warn('予定データの読み込みに失敗しました。空の状態で開始します。', error);
      }
    }
    return [];
  }

  function saveMembers() {
    localStorage.setItem(storageKeys.members, JSON.stringify(members));
  }

  function saveEvents() {
    localStorage.setItem(storageKeys.events, JSON.stringify(events));
  }

  function attachEventHandlers() {
    monthViewBtn.addEventListener('click', () => {
      state.view = 'month';
      renderCalendar();
    });

    weekViewBtn.addEventListener('click', () => {
      state.view = 'week';
      renderCalendar();
    });

    todayBtn.addEventListener('click', () => {
      const now = new Date();
      state.currentDate = new Date(now);
      state.selectedDate = new Date(now);
      renderCalendar();
      renderDayDetail(state.selectedDate);
    });

    newEventBtn.addEventListener('click', () => openEventModal());
    eventListBtn.addEventListener('click', openEventList);
    addFromDayBtn.addEventListener('click', () => openEventModal(state.selectedDate));
    backToMonthBtn.addEventListener('click', () => {
      state.view = 'month';
      renderCalendar();
    });

    prevBtn.addEventListener('click', () => {
      state.currentDate = state.view === 'month'
        ? addMonths(state.currentDate, -1)
        : addDays(state.currentDate, -7);
      renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
      state.currentDate = state.view === 'month'
        ? addMonths(state.currentDate, 1)
        : addDays(state.currentDate, 7);
      renderCalendar();
    });

    addMemberBtn.addEventListener('click', handleInlineMemberAdd);
    cancelEventBtn.addEventListener('click', closeEventModal);
    deleteEventBtn.addEventListener('click', handleModalDelete);
    eventModalOverlay.addEventListener('click', (evt) => {
      if (evt.target === eventModalOverlay) {
        closeEventModal();
      }
    });

    closeEventListBtn.addEventListener('click', closeEventList);
    eventListOverlay.addEventListener('click', (evt) => {
      if (evt.target === eventListOverlay) {
        closeEventList();
      }
    });

    eventForm.addEventListener('submit', handleEventSubmit);

    Array.from(eventForm.elements.recurrence).forEach((radio) => {
      radio.addEventListener('change', handleRecurrenceChange);
    });
  }

  function openEventList() {
    renderEventList();
    eventListOverlay.style.display = 'flex';
  }

  function closeEventList() {
    eventListOverlay.style.display = 'none';
  }

  function renderEventList() {
    eventListContainer.innerHTML = '';
    if (!events.length) {
      const empty = document.createElement('p');
      empty.className = 'helper-text';
      empty.textContent = '予定がありません。';
      eventListContainer.appendChild(empty);
      return;
    }

    const sorted = [...events].sort((a, b) => (
      a.date === b.date
        ? a.startTime.localeCompare(b.startTime)
        : a.date.localeCompare(b.date)
    ));

    sorted.forEach((event) => {
      const item = document.createElement('article');
      item.className = 'event-list-item';

      const header = document.createElement('header');

      const title = document.createElement('h4');
      title.textContent = event.title;
      header.appendChild(title);

      if (event.recurrenceGroupId) {
        const recurrenceBadge = document.createElement('span');
        recurrenceBadge.className = 'helper-text';
        recurrenceBadge.textContent = '繰り返し予定';
        header.appendChild(recurrenceBadge);
      }

      item.appendChild(header);

      const meta = document.createElement('div');
      meta.className = 'meta';

      const dateSpan = document.createElement('span');
      const dateObj = new Date(event.date);
      dateSpan.textContent = formatJapaneseDate(dateObj, { month: 'numeric', day: 'numeric', weekday: 'short' });
      meta.appendChild(dateSpan);

      const timeSpan = document.createElement('span');
      timeSpan.textContent = `${formatTime(event.startTime)}-${formatTime(event.endTime)}`;
      meta.appendChild(timeSpan);

      const membersSpan = document.createElement('span');
      const memberNames = event.memberIds.map((id) => findMemberById(id)?.name || '').filter(Boolean);
      membersSpan.textContent = memberNames.length ? memberNames.join(', ') : '担当: 未設定';
      meta.appendChild(membersSpan);

      item.appendChild(meta);

      if (event.memo) {
        const memo = document.createElement('p');
        memo.className = 'helper-text';
        memo.textContent = event.memo;
        item.appendChild(memo);
      }

      const actions = document.createElement('div');
      actions.className = 'actions';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'edit';
      editBtn.textContent = '編集';
      editBtn.addEventListener('click', () => openEventModal(new Date(event.date), event, 'list'));
      actions.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'delete';
      deleteBtn.textContent = '削除';
      deleteBtn.addEventListener('click', () => deleteEvent(event.id, { source: 'list' }));
      actions.appendChild(deleteBtn);

      item.appendChild(actions);
      eventListContainer.appendChild(item);
    });
  }

  function renderCalendar() {
    const { view, currentDate } = state;
    viewTitle.textContent = formatJapaneseDate(currentDate, { year: 'numeric', month: 'long' });
    viewSubtitle.textContent = view === 'month'
      ? '日付を押すとその日の詳細が表示されます'
      : '横にスクロールして1週間の予定を確認できます';

    monthViewBtn.classList.toggle('active', view === 'month');
    weekViewBtn.classList.toggle('active', view === 'week');

    if (view === 'month') {
      monthGrid.hidden = false;
      weekGrid.hidden = true;
      renderMonthView(currentDate);
      state.selectedDate = alignDateToMonth(state.selectedDate, currentDate);
    } else {
      monthGrid.hidden = true;
      weekGrid.hidden = false;
      renderWeekView(currentDate);
    }
  }

  function renderWeekdayHeader() {
    weekdayHeader.innerHTML = '';
    weekdayLabels.forEach((label) => {
      const span = document.createElement('span');
      span.textContent = label;
      weekdayHeader.appendChild(span);
    });
  }

  function renderMonthView(currentDate) {
    monthGrid.innerHTML = '';
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstOfMonth = new Date(year, month, 1);
    const startOffset = getWeekdayIndex(firstOfMonth);
    const gridStart = addDays(firstOfMonth, -startOffset);

    for (let i = 0; i < 42; i += 1) {
      const cellDate = addDays(gridStart, i);
      monthGrid.appendChild(createDayCell(cellDate, month));
    }
  }

  function renderWeekView(currentDate) {
    weekGrid.innerHTML = '';
    const startOfWeek = addDays(currentDate, -getWeekdayIndex(currentDate));
    for (let i = 0; i < 7; i += 1) {
      const cellDate = addDays(startOfWeek, i);
      weekGrid.appendChild(createDayCell(cellDate, currentDate.getMonth()));
    }
  }

  function createDayCell(date, activeMonth) {
    const cell = document.createElement('div');
    cell.className = 'day-cell';

    if (date.getMonth() !== activeMonth) {
      cell.classList.add('empty');
    }
    if (isSameDate(date, TODAY)) {
      cell.classList.add('today');
    }
    if (isSameDate(date, state.selectedDate)) {
      cell.classList.add('selected');
    }

    const number = document.createElement('div');
    number.className = 'day-number';
    number.textContent = date.getDate();

    const weekday = document.createElement('small');
    weekday.textContent = weekdayLabels[getWeekdayIndex(date)];
    number.appendChild(weekday);
    cell.appendChild(number);

    const dayEvents = getEventsForDate(date);
    dayEvents.slice(0, 3).forEach((event) => {
      const pill = document.createElement('div');
      pill.className = 'event-pill';

      const dot = document.createElement('span');
      dot.className = 'dot';
      dot.style.background = mergeMemberColors(event.memberIds);
      pill.appendChild(dot);

      const timeLabel = document.createElement('span');
      timeLabel.textContent = `${formatTime(event.startTime)}-${formatTime(event.endTime)}`;
      pill.appendChild(timeLabel);

      const memberNames = event.memberIds.map((id) => findMemberById(id)?.name || '');
      const memberLabel = document.createElement('strong');
      memberLabel.textContent = memberNames.join(', ');
      pill.appendChild(memberLabel);

      pill.addEventListener('click', (evt) => {
        evt.stopPropagation();
        openEventModal(new Date(event.date), event);
      });

      cell.appendChild(pill);
    });

    if (dayEvents.length > 3) {
      const more = document.createElement('span');
      more.className = 'helper-text';
      more.textContent = `他 ${dayEvents.length - 3} 件`;
      cell.appendChild(more);
    }

    cell.addEventListener('click', () => {
      state.selectedDate = new Date(date);
      state.currentDate = new Date(date);
      renderCalendar();
      renderDayDetail(date);
    });

    return cell;
  }

  function renderDayDetail(date) {
    dayDetailTitle.textContent = `${formatJapaneseDate(date, { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })} の予定`;
    const dayEvents = getEventsForDate(date).sort((a, b) => a.startTime.localeCompare(b.startTime));
    dayEventsContainer.innerHTML = '';

    if (!dayEvents.length) {
      const empty = document.createElement('div');
      empty.className = 'no-events';
      empty.textContent = '予定はありません。';
      dayEventsContainer.appendChild(empty);
      return;
    }

    dayEvents.forEach((event) => {
      const card = document.createElement('article');
      card.className = 'event-card';

      const title = document.createElement('h4');
      title.textContent = event.title;
      card.appendChild(title);

      const meta = document.createElement('div');
      meta.className = 'event-meta';

      const time = document.createElement('span');
      time.textContent = `${formatTime(event.startTime)} 〜 ${formatTime(event.endTime)}`;
      meta.appendChild(time);

      const membersLabel = document.createElement('span');
      const memberNames = event.memberIds.map((id) => findMemberById(id)?.name || '');
      membersLabel.textContent = memberNames.length ? `担当: ${memberNames.join(', ')}` : '担当: 調整中';
      meta.appendChild(membersLabel);

      card.appendChild(meta);

      if (event.memo) {
        const memo = document.createElement('p');
        memo.textContent = event.memo;
        card.appendChild(memo);
      }

      const actions = document.createElement('div');
      actions.className = 'event-actions';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'edit';
      editBtn.textContent = '編集';
      editBtn.addEventListener('click', () => openEventModal(new Date(event.date), event));
      actions.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'delete';
      deleteBtn.textContent = '削除';
      deleteBtn.addEventListener('click', () => deleteEvent(event.id));
      actions.appendChild(deleteBtn);

      card.appendChild(actions);
      dayEventsContainer.appendChild(card);
    });
  }

  function openEventModal(targetDate = null, existingEvent = null) {
    populateMemberCheckboxes();
    eventForm.reset();
    editingEvent = existingEvent || null;
    if (existingEvent) {
      deleteEventBtn.hidden = false;
      deleteEventBtn.disabled = false;
    } else {
      deleteEventBtn.hidden = true;
      deleteEventBtn.disabled = true;
    }
    eventIdInput.value = existingEvent ? existingEvent.id : '';

    const titleInput = document.getElementById('eventTitle');
    const dateInput = document.getElementById('eventDate');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const memoInput = document.getElementById('eventMemo');
    const recurrenceEndInput = document.getElementById('recurrenceEnd');
    const recurrenceField = eventForm.elements.recurrence;

    if (existingEvent) {
      titleInput.value = existingEvent.title;
      dateInput.value = existingEvent.date;
      startTimeInput.value = existingEvent.startTime;
      endTimeInput.value = existingEvent.endTime;
      memoInput.value = existingEvent.memo || '';
      recurrenceField.value = 'none';
      recurrenceEndInput.value = '';
      recurrenceEndGroup.hidden = true;

      existingEvent.memberIds.forEach((id) => {
        const checkbox = memberCheckboxes.querySelector(`input[value="${id}"]`);
        if (checkbox) checkbox.checked = true;
      });
      document.getElementById('eventModalTitle').textContent = '予定を編集';
    } else {
      const baseDate = targetDate ? formatDateInput(targetDate) : formatDateInput(state.selectedDate);
      titleInput.value = '';
      dateInput.value = baseDate;
      startTimeInput.value = '09:00';
      endTimeInput.value = '10:00';
      memoInput.value = '';
      recurrenceField.value = 'none';
      recurrenceEndInput.value = '';
      recurrenceEndGroup.hidden = true;
      document.getElementById('eventModalTitle').textContent = '予定を登録';
    }

    handleRecurrenceChange();
    eventModalOverlay.style.display = 'flex';
    titleInput.focus();
  }

  function closeEventModal() {
    eventModalOverlay.style.display = 'none';
    eventForm.reset();
    editingEvent = null;
    deleteEventBtn.hidden = true;
    deleteEventBtn.disabled = true;
  }

  function handleRecurrenceChange() {
    const selected = eventForm.elements.recurrence.value;
    const weekly = selected === 'weekly';
    weekdayPicker.setAttribute('aria-hidden', (!weekly).toString());
    weekdayPicker.querySelectorAll('input').forEach((input) => {
      input.disabled = !weekly;
      if (!weekly) input.checked = false;
    });
    const showEnd = selected !== 'none';
    recurrenceEndGroup.hidden = !showEnd;
    if (!showEnd) {
      document.getElementById('recurrenceEnd').value = '';
    }
  }

  function handleModalDelete() {
    const targetId = eventIdInput.value;
    if (!targetId) {
      return;
    }
    deleteEvent(targetId);
  }

  function populateMemberCheckboxes() {
    memberCheckboxes.innerHTML = '';
    if (!members.length) {
      const note = document.createElement('p');
      note.className = 'helper-text';
      note.textContent = 'まずメンバーを追加してください。';
      memberCheckboxes.appendChild(note);
      return;
    }

    members.forEach((member) => {
      const label = document.createElement('label');
      label.className = 'member-checkbox';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = member.id;

      const dot = document.createElement('span');
      dot.className = 'dot';
      dot.style.background = member.color;

      const name = document.createElement('span');
      name.textContent = member.name;

      label.appendChild(checkbox);
      label.appendChild(dot);
      label.appendChild(name);
      memberCheckboxes.appendChild(label);
    });
  }

  function handleInlineMemberAdd() {
    const input = document.getElementById('newMemberName');
    const name = input.value.trim();
    if (!name) {
      input.focus();
      return;
    }
    if (members.some((member) => member.name === name)) {
      alert('同じ名前のメンバーがすでに存在します。');
      return;
    }
    const color = colorPalette[members.length % colorPalette.length];
    const newMember = { id: `m${Date.now()}`, name, color };
    members.push(newMember);
    saveMembers();
    populateMemberCheckboxes();
    const checkbox = memberCheckboxes.querySelector(`input[value="${newMember.id}"]`);
    if (checkbox) {
      checkbox.checked = true;
    }
    input.value = '';
  }

  function handleEventSubmit(evt) {
    evt.preventDefault();
    const formData = new FormData(eventForm);
    const id = formData.get('eventId');
    const title = formData.get('eventTitle').trim();
    const date = formData.get('eventDate');
    const startTime = formData.get('startTime');
    const endTime = formData.get('endTime');
    const memo = formData.get('eventMemo').trim();
    const recurrence = formData.get('recurrence');
    const recurrenceEnd = formData.get('recurrenceEnd');
    const memberIds = Array.from(memberCheckboxes.querySelectorAll('input:checked')).map((input) => input.value);
    const weekdaySelections = Array.from(weekdayPicker.querySelectorAll('input:checked')).map((input) => Number(input.value));

    if (!title) {
      alert('予定の内容を入力してください。');
      return;
    }
    if (!memberIds.length) {
      alert('担当者を1人以上選択してください。');
      return;
    }
    if (startTime >= endTime) {
      alert('終了時間は開始時間より後に設定してください。');
      return;
    }
    if (recurrence !== 'none' && !recurrenceEnd) {
      alert('繰り返し予定には終了日が必要です。');
      return;
    }

    let focusDate = new Date(date);

    if (id) {
      const index = events.findIndex((event) => event.id === id);
      if (index >= 0) {
        const existing = events[index];
        const updatedEvent = {
          ...existing,
          title,
          date,
          startTime,
          endTime,
          memo,
          memberIds
        };
        if (existing.recurrenceGroupId) {
          const applyAll = confirm('この予定は繰り返し予定です。\nOK: 繰り返し全てを更新\nキャンセル: この予定のみ更新');
          if (applyAll) {
            events = events.map((event) => (
              event.recurrenceGroupId === existing.recurrenceGroupId
                ? { ...event, title, startTime, endTime, memo, memberIds }
                : event
            ));
            focusDate = new Date(existing.date);
          } else {
            events[index] = updatedEvent;
          }
        } else {
          events[index] = updatedEvent;
        }
      }
    } else {
      const timestamp = Date.now();
      const recurrenceGroupId = recurrence !== 'none' ? `rg${timestamp}` : null;
      const baseEvent = {
        id: `e${timestamp}`,
        title,
        date,
        startTime,
        endTime,
        memo,
        memberIds,
        recurrenceGroupId
      };
      const newEvents = expandRecurrence(baseEvent, recurrence, recurrenceEnd, weekdaySelections);
      events = events.concat(newEvents);
    }

    events.sort((a, b) => a.date === b.date
      ? a.startTime.localeCompare(b.startTime)
      : a.date.localeCompare(b.date));

    saveEvents();
    closeEventModal();
    state.selectedDate = focusDate;
    state.currentDate = new Date(focusDate);
    renderCalendar();
    renderDayDetail(state.selectedDate);
  }

  function expandRecurrence(baseEvent, recurrence, recurrenceEnd, weekdaySelections) {
    if (recurrence === 'none' || !recurrence) {
      return [baseEvent];
    }

    const occurrences = [baseEvent];
    const startDate = new Date(baseEvent.date);
    const endDate = new Date(recurrenceEnd);

    if (recurrence === 'daily') {
      for (let cursor = addDays(startDate, 1); cursor <= endDate; cursor = addDays(cursor, 1)) {
        occurrences.push(cloneEventOnDate(baseEvent, cursor));
      }
      return occurrences;
    }

    if (recurrence === 'weekly') {
      const targets = weekdaySelections.length ? weekdaySelections : [startDate.getDay()];
      let cursor = new Date(startDate);
      while (cursor <= endDate) {
        targets.forEach((target) => {
          const occurrence = nextOrSameWeekday(cursor, target);
          if (occurrence >= startDate && occurrence <= endDate) {
            occurrences.push(cloneEventOnDate(baseEvent, occurrence));
          }
        });
        cursor = addDays(cursor, 7);
      }
      const unique = new Map();
      occurrences.forEach((event) => {
        unique.set(`${event.date}-${event.startTime}-${event.title}`, event);
      });
      return Array.from(unique.values()).sort((a, b) => a.date.localeCompare(b.date));
    }

    return [baseEvent];
  }

  function cloneEventOnDate(event, date) {
    return {
      ...event,
      id: `e${Date.now()}${Math.random().toString(16).slice(2)}`,
      date: formatDateInput(date)
    };
  }

  function deleteEvent(eventId, options = {}) {
    const target = events.find((event) => event.id === eventId);
    if (!target) {
      return;
    }
    if (!confirm('この予定を削除しますか？')) {
      return;
    }

    if (target.recurrenceGroupId) {
      const applyAll = confirm('この予定は繰り返し予定です。\nOK: 繰り返し全てを削除\nキャンセル: この予定のみ削除');
      if (applyAll) {
        events = events.filter((event) => event.recurrenceGroupId !== target.recurrenceGroupId);
      } else {
        events = events.filter((event) => event.id !== eventId);
      }
    } else {
      events = events.filter((event) => event.id !== eventId);
    }

    saveEvents();
    const focusDate = new Date(target.date);
    state.selectedDate = focusDate;
    state.currentDate = new Date(focusDate);
    closeEventModal();
    renderCalendar();
    renderDayDetail(state.selectedDate);
  }

  function getEventsForDate(date) {
    const iso = formatDateInput(date);
    return events.filter((event) => event.date === iso);
  }

  function findMemberById(id) {
    return members.find((member) => member.id === id);
  }

  function mergeMemberColors(memberIds) {
    if (!memberIds.length) {
      return '#d7d9e0';
    }
    if (memberIds.length === 1) {
      return findMemberById(memberIds[0])?.color || '#d7d9e0';
    }
    const totals = memberIds.reduce((acc, memberId) => {
      const { r, g, b } = hexToRgb(findMemberById(memberId)?.color || '#d7d9e0');
      return { r: acc.r + r, g: acc.g + g, b: acc.b + b };
    }, { r: 0, g: 0, b: 0 });
    const count = memberIds.length;
    return `rgb(${Math.round(totals.r / count)}, ${Math.round(totals.g / count)}, ${Math.round(totals.b / count)})`;
  }

  function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
  }

  function addMonths(date, months) {
    const result = new Date(date);
    result.setMonth(result.getMonth() + months);
    return result;
  }

  function nextOrSameWeekday(startDate, targetWeekday) {
    const result = new Date(startDate);
    const diff = (targetWeekday + 7 - result.getDay()) % 7;
    result.setDate(result.getDate() + diff);
    return result;
  }

  function getWeekdayIndex(date) {
    return (date.getDay() + 6) % 7;
  }

  function alignDateToMonth(date, monthDate) {
    if (date.getFullYear() === monthDate.getFullYear() && date.getMonth() === monthDate.getMonth()) {
      return date;
    }
    return new Date(monthDate.getFullYear(), monthDate.getMonth(), 1);
  }

  function isSameDate(a, b) {
    return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
  }

  function formatJapaneseDate(date, options = {}) {
    return new Intl.DateTimeFormat('ja-JP', options).format(date);
  }

  function formatDateInput(date) {
    const year = date.getFullYear();
    const month = `${date.getMonth() + 1}`.padStart(2, '0');
    const day = `${date.getDate()}`.padStart(2, '0');
    return `${year}-${month}-${day}`;
  }

  function formatTime(timeStr) {
    if (!timeStr) return '';
    const [hour, minute] = timeStr.split(':');
    return `${hour.padStart(2, '0')}:${minute.padStart(2, '0')}`;
  }

  function hexToRgb(hex) {
    const normalized = hex.replace('#', '');
    const intValue = parseInt(normalized, 16);
    return {
      r: (intValue >> 16) & 255,
      g: (intValue >> 8) & 255,
      b: intValue & 255
    };
  }
</script>
</body>
</html>

